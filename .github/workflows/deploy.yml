name: Deploy to k3s

on:
  push:
    branches: [master]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-1
  PROJECT_NAME: fortune-compass
  ENVIRONMENT: dev

jobs:
  test-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: backend/package-lock.json
      - run: cd backend && npm ci
      - run: cd backend && npm test

  build-and-deploy:
    needs: [test-backend]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/fortune-compass-github-actions
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push backend image
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build \
            -t $ECR_REGISTRY/${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}-backend:$IMAGE_TAG \
            -t $ECR_REGISTRY/${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}-backend:latest \
            backend/
          docker push $ECR_REGISTRY/${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}-backend --all-tags

      - name: Build and push frontend image
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build \
            -t $ECR_REGISTRY/${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}-frontend:$IMAGE_TAG \
            -t $ECR_REGISTRY/${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}-frontend:latest \
            frontend/
          docker push $ECR_REGISTRY/${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT }}-frontend --all-tags

      - name: Deploy to k3s via SSH
        uses: appleboy/ssh-action@v1
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: ECR_REGISTRY,IMAGE_TAG,AWS_REGION,ANTHROPIC_API_KEY
          script: |
            # Create/update Anthropic API key secret
            sudo k3s kubectl create secret generic anthropic-api-key \
              --from-literal=ANTHROPIC_API_KEY="$ANTHROPIC_API_KEY" \
              -n fortune-compass \
              --dry-run=client -o yaml | sudo k3s kubectl apply -f -

            # Refresh ECR pull secret
            TOKEN=$(aws ecr get-login-password --region $AWS_REGION)
            sudo k3s kubectl create secret docker-registry ecr-secret \
              --docker-server=$ECR_REGISTRY \
              --docker-username=AWS \
              --docker-password="$TOKEN" \
              -n fortune-compass \
              --dry-run=client -o yaml | sudo k3s kubectl apply -f -

            # Update deployment images
            sudo k3s kubectl set image deployment/backend \
              backend=$ECR_REGISTRY/fortune-compass-dev-backend:$IMAGE_TAG \
              -n fortune-compass
            sudo k3s kubectl set image deployment/frontend \
              frontend=$ECR_REGISTRY/fortune-compass-dev-frontend:$IMAGE_TAG \
              -n fortune-compass

            # Wait for rollout
            sudo k3s kubectl rollout status deployment/backend -n fortune-compass --timeout=120s
            sudo k3s kubectl rollout status deployment/frontend -n fortune-compass --timeout=120s

            # Show status
            sudo k3s kubectl get pods -n fortune-compass
