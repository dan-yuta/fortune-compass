# Fortune Compass テスト設計書（MVP）

## 1. テスト方針

### スコープ
MVPでは**バックエンドの占いロジック**を重点的にテストする。
フロントエンドはE2Eテストではなく**手動確認**で対応。

### テストツール
| 種別 | ツール |
|------|-------|
| バックエンド単体テスト | Jest + ts-jest |
| APIテスト | supertest |
| フロントエンド | 手動確認（MVP） |

### テストファイル配置
```
backend/
├── src/
│   └── services/
│       ├── zodiac.ts
│       ├── numerology.ts
│       ├── blood-type.ts
│       └── tarot.ts
└── __tests__/
    ├── services/
    │   ├── zodiac.test.ts
    │   ├── numerology.test.ts
    │   ├── blood-type.test.ts
    │   └── tarot.test.ts
    └── routes/
        └── fortune.test.ts
```

---

## 2. 単体テスト: 星座占い（zodiac.service）

### TC-Z001: 星座判定 — 各星座の境界値

| テストID | 入力（月/日） | 期待する星座 | 備考 |
|---------|-------------|------------|------|
| TC-Z001-01 | 3/21 | 牡羊座 | 開始境界 |
| TC-Z001-02 | 4/19 | 牡羊座 | 終了境界 |
| TC-Z001-03 | 4/20 | 牡牛座 | 開始境界 |
| TC-Z001-04 | 5/20 | 牡牛座 | 終了境界 |
| TC-Z001-05 | 5/21 | 双子座 | 開始境界 |
| TC-Z001-06 | 6/21 | 双子座 | 終了境界 |
| TC-Z001-07 | 6/22 | 蟹座 | 開始境界 |
| TC-Z001-08 | 7/22 | 蟹座 | 終了境界 |
| TC-Z001-09 | 7/23 | 獅子座 | 開始境界 |
| TC-Z001-10 | 8/22 | 獅子座 | 終了境界 |
| TC-Z001-11 | 8/23 | 乙女座 | 開始境界 |
| TC-Z001-12 | 9/22 | 乙女座 | 終了境界 |
| TC-Z001-13 | 9/23 | 天秤座 | 開始境界 |
| TC-Z001-14 | 10/23 | 天秤座 | 終了境界 |
| TC-Z001-15 | 10/24 | 蠍座 | 開始境界 |
| TC-Z001-16 | 11/22 | 蠍座 | 終了境界 |
| TC-Z001-17 | 11/23 | 射手座 | 開始境界 |
| TC-Z001-18 | 12/21 | 射手座 | 終了境界 |
| TC-Z001-19 | 12/22 | 山羊座 | 開始境界 |
| TC-Z001-20 | 1/19 | 山羊座 | 終了境界（年跨ぎ） |
| TC-Z001-21 | 1/20 | 水瓶座 | 開始境界 |
| TC-Z001-22 | 2/18 | 水瓶座 | 終了境界 |
| TC-Z001-23 | 2/19 | 魚座 | 開始境界 |
| TC-Z001-24 | 3/20 | 魚座 | 終了境界 |

### TC-Z002: エレメント判定

| テストID | 星座 | 期待するエレメント |
|---------|------|----------------|
| TC-Z002-01 | 牡羊座 | 火 |
| TC-Z002-02 | 牡牛座 | 地 |
| TC-Z002-03 | 双子座 | 風 |
| TC-Z002-04 | 蟹座 | 水 |

### TC-Z003: 運勢スコア

| テストID | 検証内容 | 期待結果 |
|---------|---------|---------|
| TC-Z003-01 | スコアが1〜5の範囲内 | 1 <= score <= 5 |
| TC-Z003-02 | 同日・同星座で同じスコア | score1 === score2 |
| TC-Z003-03 | 異なる日付で異なるスコア（高確率） | score1 !== score2 |

### TC-Z004: レスポンス形式

| テストID | 検証内容 | 期待結果 |
|---------|---------|---------|
| TC-Z004-01 | 必須フィールドが全て存在する | sign, element, score, luckyColor, luckyItem, advice が存在 |
| TC-Z004-02 | fortuneType が "zodiac" | fortuneType === "zodiac" |

---

## 3. 単体テスト: 数秘術（numerology.service）

### TC-N001: 運命数算出

| テストID | 入力（生年月日） | 計算過程 | 期待する運命数 |
|---------|----------------|---------|-------------|
| TC-N001-01 | 1990-05-15 | 1+9+9+0+0+5+1+5=30 → 3+0=3 | 3 |
| TC-N001-02 | 1985-11-29 | 1+9+8+5+1+1+2+9=36 → 3+6=9 | 9 |
| TC-N001-03 | 2000-01-01 | 2+0+0+0+0+1+0+1=4 | 4 |
| TC-N001-04 | 1992-02-29 | 1+9+9+2+0+2+2+9=34 → 3+4=7 | 7 |

### TC-N002: マスターナンバー

| テストID | 入力 | 計算過程 | 期待する運命数 |
|---------|------|---------|-------------|
| TC-N002-01 | 合計が11になる日付 | → 11 | 11（1桁にしない） |
| TC-N002-02 | 合計が22になる日付 | → 22 | 22（1桁にしない） |
| TC-N002-03 | 合計が33になる日付 | → 33 | 33（1桁にしない） |

### TC-N003: 名前の数値化（ピタゴリアン変換）

| テストID | 入力（ローマ字） | 期待結果 |
|---------|----------------|---------|
| TC-N003-01 | "yamada" | 各文字変換 → 合計 → 1桁 |
| TC-N003-02 | "taro" | 各文字変換 → 合計 → 1桁 |
| TC-N003-03 | "" （空文字） | null or 0（名前なしでも動作） |

### TC-N004: レスポンス形式

| テストID | 検証内容 | 期待結果 |
|---------|---------|---------|
| TC-N004-01 | 運命数が 1-9, 11, 22, 33 のいずれか | 有効な運命数 |
| TC-N004-02 | personalityTraits が配列 | Array.isArray() === true |
| TC-N004-03 | compatibility が配列 | Array.isArray() === true |

---

## 4. 単体テスト: 血液型占い（blood-type.service）

### TC-B001: 血液型バリデーション

| テストID | 入力 | 期待結果 |
|---------|------|---------|
| TC-B001-01 | "A" | 正常レスポンス |
| TC-B001-02 | "B" | 正常レスポンス |
| TC-B001-03 | "O" | 正常レスポンス |
| TC-B001-04 | "AB" | 正常レスポンス |
| TC-B001-05 | "C" | エラー（無効な血液型） |
| TC-B001-06 | "" | エラー（空文字） |

### TC-B002: レスポンス形式

| テストID | 検証内容 | 期待結果 |
|---------|---------|---------|
| TC-B002-01 | personality が空でない文字列 | typeof === "string" && length > 0 |
| TC-B002-02 | score が 1〜5 の範囲 | 1 <= score <= 5 |
| TC-B002-03 | compatibilityRanking が4要素の配列 | length === 4 |
| TC-B002-04 | compatibilityRanking に A,B,O,AB が全て含まれる | 4種全て存在 |

---

## 5. 単体テスト: タロット占い（tarot.service）

### TC-T001: カード抽出

| テストID | 検証内容 | 期待結果 |
|---------|---------|---------|
| TC-T001-01 | 3枚のカードが返される | cards.length === 3 |
| TC-T001-02 | 3枚が全て異なるカード | 重複なし（number が全て異なる） |
| TC-T001-03 | カード番号が 0〜21 の範囲 | 0 <= number <= 21 |
| TC-T001-04 | 各カードに正逆位置が設定されている | isReversed が boolean |

### TC-T002: スプレッド構成

| テストID | 検証内容 | 期待結果 |
|---------|---------|---------|
| TC-T002-01 | 1枚目の position が "past" | cards[0].position === "past" |
| TC-T002-02 | 2枚目の position が "present" | cards[1].position === "present" |
| TC-T002-03 | 3枚目の position が "future" | cards[2].position === "future" |

### TC-T003: カードデータの完全性

| テストID | 検証内容 | 期待結果 |
|---------|---------|---------|
| TC-T003-01 | 全カードに name が存在 | name が空でない文字列 |
| TC-T003-02 | 全カードに meaning が存在 | meaning が空でない文字列 |
| TC-T003-03 | 全カードに reversedMeaning が存在 | reversedMeaning が空でない文字列 |
| TC-T003-04 | 大アルカナ22枚のデータが存在 | 全22枚のマスタデータ |

### TC-T004: ランダム性

| テストID | 検証内容 | 期待結果 |
|---------|---------|---------|
| TC-T004-01 | 複数回実行で異なる結果が出る | 10回中少なくとも2種類以上の結果 |

---

## 6. APIテスト（supertest）

### TC-API001: 星座占いエンドポイント

| テストID | Method/Path | リクエスト | 期待 | 検証 |
|---------|------------|-----------|------|------|
| TC-API001-01 | POST /api/fortune/zodiac | `{"birthday":"1990-05-15"}` | 200 | 正常レスポンス |
| TC-API001-02 | POST /api/fortune/zodiac | `{}` | 400 | バリデーションエラー |
| TC-API001-03 | POST /api/fortune/zodiac | `{"birthday":"invalid"}` | 400 | 不正な日付 |

### TC-API002: 数秘術エンドポイント

| テストID | Method/Path | リクエスト | 期待 | 検証 |
|---------|------------|-----------|------|------|
| TC-API002-01 | POST /api/fortune/numerology | `{"birthday":"1990-05-15","name":"yamada taro"}` | 200 | 正常レスポンス |
| TC-API002-02 | POST /api/fortune/numerology | `{"birthday":"1990-05-15"}` | 200 | 名前なしでも動作 |
| TC-API002-03 | POST /api/fortune/numerology | `{}` | 400 | バリデーションエラー |

### TC-API003: 血液型占いエンドポイント

| テストID | Method/Path | リクエスト | 期待 | 検証 |
|---------|------------|-----------|------|------|
| TC-API003-01 | POST /api/fortune/blood-type | `{"bloodType":"A"}` | 200 | 正常レスポンス |
| TC-API003-02 | POST /api/fortune/blood-type | `{}` | 400 | バリデーションエラー |
| TC-API003-03 | POST /api/fortune/blood-type | `{"bloodType":"X"}` | 400 | 不正な血液型 |

### TC-API004: タロット占いエンドポイント

| テストID | Method/Path | リクエスト | 期待 | 検証 |
|---------|------------|-----------|------|------|
| TC-API004-01 | POST /api/fortune/tarot | `{}` | 200 | 正常レスポンス |

---

## 7. 手動テスト: フロントエンド

### TC-FE001: 画面遷移

| テストID | 操作 | 期待結果 |
|---------|------|---------|
| TC-FE001-01 | トップページにアクセス | アプリタイトルとCTAボタンが表示 |
| TC-FE001-02 | CTAボタンクリック（未登録） | `/profile` に遷移 |
| TC-FE001-03 | プロフィール保存後 | `/fortune` に遷移 |
| TC-FE001-04 | CTAボタンクリック（登録済み） | `/fortune` に遷移 |
| TC-FE001-05 | 占術カードクリック | 対応する結果ページに遷移 |
| TC-FE001-06 | 「他の占いを試す」クリック | `/fortune` に遷移 |

### TC-FE002: プロフィール入力

| テストID | 操作 | 期待結果 |
|---------|------|---------|
| TC-FE002-01 | 必須項目未入力で保存 | バリデーションエラー表示 |
| TC-FE002-02 | 全必須項目入力で保存 | localStorage に保存、遷移 |
| TC-FE002-03 | 再度プロフィール画面を開く | 保存済みデータが入力欄に表示 |

### TC-FE003: 占い結果表示

| テストID | 操作 | 期待結果 |
|---------|------|---------|
| TC-FE003-01 | 星座占い実行 | スコア、ラッキーカラー等が表示 |
| TC-FE003-02 | 数秘術実行 | 運命数、性格特徴等が表示 |
| TC-FE003-03 | 血液型占い実行 | 性格、相性ランキング等が表示 |
| TC-FE003-04 | タロット占い実行 | 3枚のカードと総合メッセージが表示 |
| TC-FE003-05 | 血液型未登録で血液型占い | 適切なエラーまたは登録誘導 |

### TC-FE004: レスポンシブ

| テストID | 画面幅 | 検証内容 |
|---------|-------|---------|
| TC-FE004-01 | 375px（モバイル） | 全画面が崩れず表示 |
| TC-FE004-02 | 768px（タブレット） | 占術カードが2列表示 |
| TC-FE004-03 | 1024px（デスクトップ） | 適切な最大幅で中央寄せ |

---

## 8. テスト実行コマンド

```bash
# バックエンド全テスト
cd backend && npm test

# 特定テストのみ
cd backend && npm test -- --testPathPattern=zodiac

# カバレッジ付き
cd backend && npm test -- --coverage
```
