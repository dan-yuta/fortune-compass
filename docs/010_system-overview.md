# Fortune Compass — システム全体解説書

> 本ドキュメントは Fortune Compass のシステム構成・仕組み・技術的詳細を人に説明するために作成したものです。
> アプリの画面フロー、占いロジック、バックエンド/フロントエンドの設計、インフラ構成、CI/CD まで網羅しています。

---

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [システム全体構成図](#2-システム全体構成図)
3. [画面フローと機能](#3-画面フローと機能)
4. [フロントエンド設計](#4-フロントエンド設計)
5. [バックエンド設計](#5-バックエンド設計)
6. [占いロジック詳細](#6-占いロジック詳細)
7. [データフロー](#7-データフロー)
8. [デザインシステム](#8-デザインシステム)
9. [Docker 構成](#9-docker-構成)
10. [AWS インフラ構成](#10-aws-インフラ構成)
11. [CI/CD パイプライン](#11-cicd-パイプライン)
12. [セキュリティ設計](#12-セキュリティ設計)
13. [ファイル一覧](#13-ファイル一覧)

---

## 1. プロジェクト概要

### 何を作ったか

**Fortune Compass** は、19 の占術（4カテゴリ: 定番・誕生日・伝統・特殊）で毎日の運勢を占える Web アプリケーションです。

### 基本情報

| 項目 | 内容 |
|------|------|
| アプリ名 | Fortune Compass |
| アプリURL | https://d71oywvumn06c.cloudfront.net |
| GitHub | https://github.com/dan-yuta/fortune-compass (private) |
| フロントエンド | Next.js 16.1.6 (App Router) + Tailwind CSS v4 |
| バックエンド | Express 5.x + TypeScript |
| インフラ | AWS (CloudFront / EC2 + k3s / ECR / VPC) |
| IaC | Terraform（~80 リソース） |
| CI/CD | GitHub Actions（OIDC 認証） |
| テスト (Backend) | Jest + Supertest（75 テストケース / カバレッジ 90.17%） |
| テスト (Frontend) | Jest + React Testing Library（31 テストケース） |
| E2E テスト | Playwright（25 テストケース） |

### 対応する占術

| カテゴリ | 占術 | 入力 | 結果 | 日替わり |
|---------|------|------|------|---------|
| 定番 (Classic) | 星座占い | 生年月日 | 星座・スコア・ラッキーカラー・ラッキーアイテム・アドバイス | はい |
| 定番 (Classic) | 数秘術 | 生年月日 + 名前 | 運命数・性格特徴・年運・相性数・アドバイス | いいえ（固定） |
| 定番 (Classic) | 血液型占い | 血液型 | 性格・スコア・相性ランキング・アドバイス | はい |
| 定番 (Classic) | タロット占い | なし | 3 枚のカード（過去・現在・未来）+ 総合メッセージ | 毎回変動 |
| 誕生日 (Birthday) | 干支占い | 生年月日 | 十二支・性格・相性 | いいえ（固定） |
| 誕生日 (Birthday) | 九星気学 | 生年月日 | 九星・本命星・性格・方位 | いいえ（固定） |
| 誕生日 (Birthday) | 動物占い | 生年月日 | 動物キャラ（60パターン）・グループ（SUN/EARTH/MOON）・性格・相性 | いいえ（固定） |
| 誕生日 (Birthday) | 誕生花占い | 生年月日 | 誕生花・花言葉・性格 | いいえ（固定） |
| 誕生日 (Birthday) | 誕生石占い | 生年月日 | 誕生石・石言葉・パワー | いいえ（固定） |
| 誕生日 (Birthday) | 四柱推命 | 生年月日 | 天干地支・五行・性格・運勢 | いいえ（固定） |
| 誕生日 (Birthday) | 曜日占い | 生年月日 | 曜日・性格・ラッキー情報 | いいえ（固定） |
| 誕生日 (Birthday) | 風水占い | 生年月日 | 本命卦・吉方位・ラッキーカラー | いいえ（固定） |
| 伝統 (Traditional) | おみくじ | なし | 大吉〜大凶（7段階）・各運勢 | 毎回変動 |
| 伝統 (Traditional) | ルーン占い | なし | 3石選択（過去・現在・未来）・24ルーン | 毎回変動 |
| 特殊 (Special) | 夢占い | キーワード | 夢の意味・深層心理・アドバイス | いいえ（固定） |
| 特殊 (Special) | 手相占い(AI) | 手の画像 | Claude Vision による手相解析 | いいえ（固定） |
| 特殊 (Special) | 相性占い | 2人の生年月日 + 名前? + 血液型? | 星座・血液型・数秘の3軸相性スコア + アドバイス | いいえ（固定） |
| 特殊 (Special) | 運勢トレンド | 生年月日 + 名前? + 血液型? | 7日間の運勢推移グラフ（4カテゴリ） | はい |
| 特殊 (Special) | AI総合鑑定 | 生年月日 + 名前? + 血液型? | Claude APIによる全占い統合鑑定文 | はい |
| — | 総合ダッシュボード | 生年月日 + 名前? + 血液型? | レーダーチャート（4軸）+ 各占術サマリー + 総合アドバイス | はい |

---

## 2. システム全体構成図

### 本番環境（AWS）— 全体構成図

```
                              ┌──────────┐
                              │  ユーザー │
                              │(ブラウザ) │
                              └────┬─────┘
                                   │ HTTPS
                          ┌────────▼────────────────────────────┐
                          │         CloudFront (CDN)             │
                          │                                      │
                          │  /_next/static/* → キャッシュ（7日）  │
                          │  /api/*          → EC2 に転送        │
                          │  /admin*         → S3 管理コンソール  │
                          │  /*              → EC2 に転送        │
                          │                                      │
                          │  CF Function: /admin → /index.html   │
                          └──┬──────────────────────┬────────────┘
                             │ HTTP                  │ HTTP
              ┌──────────────▼───────────────┐   ┌──▼─────────────────────┐
              │  EC2 (t3.small)  Public Subnet│   │  S3 Static Website     │
              │  ┌─────────────────────────┐  │   │  管理コンソール UI      │
              │  │  k3s + Traefik Ingress  │  │   │  (HTML/CSS/JS)         │
              │  │  /api/* → backend:8080  │  │   └──────────┬────────────┘
              │  │  /*     → frontend:3000 │  │              │ API呼び出し
              │  ├─────────────┬───────────┤  │   ┌──────────▼────────────┐
              │  │ Pod:Backend │Pod:Frontend│  │   │  API Gateway          │
              │  │ Express     │ Next.js    │  │   │  (API Key 認証)       │
              │  │ :8080       │ :3000      │  │   └──────────┬────────────┘
              │  └─────────────┴───────────┘  │              │
              │  SSM Agent (リモートコマンド)   │   ┌──────────▼────────────┐
              └──────────────┬────────────────┘   │  Step Functions       │
                             │                     │  起動/停止ワークフロー │
                             │                     └──────────┬────────────┘
                             │                                │
                             │        ┌───────────────────────▼──┐
                             │        │  Lambda (ec2_manager.py)  │
                             │        │  start / stop / status    │
                             │  ◄─────│  health_check / ecr_refresh│
                             │  EC2操作└──────────────────────────┘
                             │
     ┌───────────────────────▼──────────────────────────┐
     │                  ECR (コンテナレジストリ)           │
     │  fortune-compass-dev-backend  :latest / :sha     │
     │  fortune-compass-dev-frontend :latest / :sha     │
     └──────────────────────────────────────────────────┘

     ┌──────────────────────────────────────────────────┐
     │              追加 AWS サービス群                    │
     │                                                    │
     │  ┌─────────────┐  ┌──────────────────────────┐   │
     │  │ MediaConvert │  │ セキュリティ監査           │   │
     │  │ S3(input)    │  │ Security Hub / GuardDuty │   │
     │  │  ↓ Lambda    │  │ Inspector / Config       │   │
     │  │  ↓ 変換ジョブ │  │ IAM Access Analyzer     │   │
     │  │ S3(output)   │  └──────────────────────────┘   │
     │  └─────────────┘                                   │
     │  ┌──────────────────────────────────────────┐     │
     │  │ Bedrock Agent（占いコンシェルジュ）         │     │
     │  │ ユーザー → Agent → Claude → Lambda → API  │     │
     │  └──────────────────────────────────────────┘     │
     └──────────────────────────────────────────────────┘
```

### 管理コンソール操作フロー（EC2 起動・停止）

管理コンソール（`https://d71oywvumn06c.cloudfront.net/admin`）から EC2 を起動・停止できます。

```
┌─────────────────────────────────────────────────────────────┐
│  管理者がブラウザで /admin にアクセス                          │
│     │                                                        │
│     ▼                                                        │
│  管理コンソール UI（S3 静的サイト）                             │
│     │                                                        │
│     │ ボタンクリック: [起動] or [停止] or [ステータス確認]       │
│     ▼                                                        │
│  API Gateway (POST /prod/manage)                             │
│     │ API Key 認証                                            │
│     ▼                                                        │
│  ┌─── 起動の場合 ──────────────────────────────────┐         │
│  │ Step Functions (Start Workflow)                  │         │
│  │   ① Lambda: EC2 起動コマンド送信                  │         │
│  │   ② 60秒待機（EC2 起動待ち）                      │         │
│  │   ③ Lambda: ステータス確認（running?）             │         │
│  │      ├─ running → ④ へ                           │         │
│  │      └─ まだ → ②に戻る（最大5回リトライ）          │         │
│  │   ④ Lambda: ヘルスチェック（アプリ応答確認）        │         │
│  │   ⑤ Lambda: ECR トークンリフレッシュ（SSM経由）    │         │
│  │   ⑥ 完了                                         │         │
│  └──────────────────────────────────────────────────┘         │
│                                                               │
│  ┌─── 停止の場合 ──────────────────────────────────┐         │
│  │ Step Functions (Stop Workflow)                   │         │
│  │   ① Lambda: EC2 停止コマンド送信                  │         │
│  │   ② 30秒待機（EC2 停止待ち）                      │         │
│  │   ③ Lambda: ステータス確認（stopped?）             │         │
│  │      ├─ stopped → 完了                           │         │
│  │      └─ まだ → ②に戻る（最大5回リトライ）          │         │
│  └──────────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

**コスト効果**: EC2 停止中は ~$4/月（EBS + ECR + S3 のみ）。起動中は ~$13/月。

### ローカル開発環境

```
    ┌──────────────────┐
    │    ブラウザ        │
    │  localhost:3000   │
    └────────┬─────────┘
             │
    ┌────────▼─────────┐        ┌──────────────────┐
    │  Next.js (dev)   │        │  Express (dev)   │
    │  :3000           │───────→│  :8080           │
    │                  │ proxy  │                  │
    │  next dev        │/api/*  │  ts-node-dev     │
    └──────────────────┘        └──────────────────┘
             │
    ┌────────▼─────────┐
    │  localStorage    │
    │  プロフィール保存  │
    └──────────────────┘
```

**開発時と本番の違い:**
- 開発: Next.js の `rewrites` で `/api/*` をバックエンドにプロキシ
- 本番: k3s 内蔵 Traefik Ingress がパスベースで直接振り分け（プロキシ不要）

---

## 3. 画面フローと機能

### 画面遷移図

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                                                                 │
│  トップページ (/)                                                                │
│  ┌───────────────────────────────────────────────────────────────────────┐      │
│  │  ✦ Fortune Compass                                                    │      │
│  │  あなたの運命を照らす総合占い                                             │      │
│  │                                                                       │      │
│  │  [占いを始める] ← プロフィール有無で遷移先が変わる                        │      │
│  │                                                                       │      │
│  │  ┌─────────────────── 定番 (Classic) ──────────────────────┐          │      │
│  │  │ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐            │          │      │
│  │  │ │ 星座   │ │ 数秘術 │ │ 血液型 │ │ タロット│            │          │      │
│  │  │ │ 占い   │ │        │ │ 占い   │ │ 占い   │            │          │      │
│  │  │ └────────┘ └────────┘ └────────┘ └────────┘            │          │      │
│  │  └────────────────────────────────────────────────────────┘          │      │
│  │  ┌─────────────────── 誕生日 (Birthday) ──────────────────┐          │      │
│  │  │ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐            │          │      │
│  │  │ │ 干支   │ │ 九星   │ │ 動物   │ │ 誕生花 │            │          │      │
│  │  │ │ 占い   │ │ 気学   │ │ 占い   │ │ 占い   │            │          │      │
│  │  │ └────────┘ └────────┘ └────────┘ └────────┘            │          │      │
│  │  │ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐            │          │      │
│  │  │ │ 誕生石 │ │ 四柱   │ │ 曜日   │ │ 風水   │            │          │      │
│  │  │ │ 占い   │ │ 推命   │ │ 占い   │ │ 占い   │            │          │      │
│  │  │ └────────┘ └────────┘ └────────┘ └────────┘            │          │      │
│  │  └────────────────────────────────────────────────────────┘          │      │
│  │  ┌─────────── 伝統 (Traditional) ────┐ ┌─── 特殊 (Special) ──┐     │      │
│  │  │ ┌────────┐ ┌────────┐              │ │ ┌────────┐ ┌────────┐│     │      │
│  │  │ │ おみくじ│ │ ルーン │              │ │ │ 夢占い │ │ 手相   ││     │      │
│  │  │ │        │ │ 占い   │              │ │ │        │ │ 占い   ││     │      │
│  │  │ └────────┘ └────────┘              │ │ └────────┘ └────────┘│     │      │
│  │  └────────────────────────────────────┘ └─────────────────────┘     │      │
│  └───────────────────────────────────────────────────────────────────────┘      │
│         │                                                                       │
│         │ プロフィール未登録                                                      │
│         ▼                                                                       │
│  プロフィール入力 (/profile)                                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐      │
│  │  名前:     [            ]                                             │      │
│  │  フリガナ:  [            ] (カタカナ → ローマ字自動変換)                  │      │
│  │  生年月日:  [年▼] [月▼] [日▼]                                          │      │
│  │  血液型:   [A] [B] [O] [AB] (任意)                                    │      │
│  │                                                                       │      │
│  │  [保存して占う] → localStorage に保存                                   │      │
│  └───────────────────────────────────────────────────────────────────────┘      │
│         │                                                                       │
│         ▼                                                                       │
│  占術選択 (/fortune)                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐      │
│  │  〇〇さん、今日の運勢を占いましょう                                       │      │
│  │                                                                       │      │
│  │  19占術（4カテゴリ）から選択                                             │      │
│  │  ┌─────────── 定番 ──────────────────────────────────────┐            │      │
│  │  │ ☆ 星座占い / # 数秘術 / 💧 血液型 / 🂡 タロット       │            │      │
│  │  └───────────────────────────────────────────────────────┘            │      │
│  │  ┌─────────── 誕生日 ────────────────────────────────────┐            │      │
│  │  │ 🐲 干支 / ⭐ 九星気学 / 🐾 動物 / 🌸 誕生花           │            │      │
│  │  │ 💎 誕生石 / 📜 四柱推命 / 📅 曜日 / 🧭 風水           │            │      │
│  │  └───────────────────────────────────────────────────────┘            │      │
│  │  ┌─── 伝統 ───────────┐  ┌─── 特殊 ──────────────┐                  │      │
│  │  │ 🎋 おみくじ / ᚱ ルーン│  │ 💭 夢占い / ✋ 手相(AI)│                  │      │
│  │  └─────────────────────┘  └───────────────────────┘                  │      │
│  │  ※血液型未登録時は血液型占いがグレーアウト                                │      │
│  └─────────┼─────────────────────────────────────────────────────────────┘      │
│            │                                                                     │
│    ┌───────┼────────────────────────────────────────────────┐                    │
│    ▼       ▼                                                │                    │
│  各占術結果ページ（19種）                                      │                    │
│  星座 / 数秘術 / 血液型 / タロット / 干支 / 九星気学 /          │                    │
│  動物 / 誕生花 / 誕生石 / 四柱推命 / 曜日 / 風水 /             │                    │
│  おみくじ / ルーン / 夢占い / 手相(AI) / 相性 / トレンド / AI鑑定│                    │
│                                                              │                    │
│         ←── 戻る ──────────────────────────────────────────┘                    │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 各画面の詳細

| 画面 | パス | 説明 |
|------|------|------|
| トップ | `/` | ヒーローセクション + CTA ボタン + 19 占術アイコン（4カテゴリ） |
| プロフィール | `/profile` | 名前・フリガナ・生年月日・血液型の入力フォーム |
| 占術選択 | `/fortune` | ダッシュボードバナー + 19占術カード選択（4カテゴリ）。未登録なら `/profile` にリダイレクト |
| ダッシュボード | `/fortune/dashboard` | 4 占術一括実行 + SVG レーダーチャート + サマリーカード + 総合アドバイス |
| 星座結果 | `/fortune/zodiac` | 星座名・スコア・ラッキーカラー/アイテム・アドバイス + 他占術ショートカット + SNSシェア |
| 数秘術結果 | `/fortune/numerology` | 運命数・性格バッジ・年運・相性数 + 他占術ショートカット + SNSシェア |
| 血液型結果 | `/fortune/blood-type` | 血液型・スコア・性格・相性ランキング・アドバイス + 他占術ショートカット + SNSシェア |
| タロット結果 | `/fortune/tarot` | 3 枚カード表示 + 正逆位置 + 各カード解釈 + 総合メッセージ + 他占術ショートカット + SNSシェア |
| 干支結果 | `/fortune/eto` | 十二支・性格・相性 + 他占術ショートカット + SNSシェア |
| 九星気学結果 | `/fortune/kyusei` | 九星・本命星・性格・方位 + 他占術ショートカット + SNSシェア |
| 動物占い結果 | `/fortune/animal` | 動物キャラ（60パターン）・性格・相性 + 他占術ショートカット + SNSシェア |
| 誕生花結果 | `/fortune/birth-flower` | 誕生花・花言葉・性格 + 他占術ショートカット + SNSシェア |
| 誕生石結果 | `/fortune/birthstone` | 誕生石・石言葉・パワー + 他占術ショートカット + SNSシェア |
| 四柱推命結果 | `/fortune/shichuu` | 天干地支・五行・性格・運勢 + 他占術ショートカット + SNSシェア |
| 曜日占い結果 | `/fortune/weekday` | 曜日・性格・ラッキー情報 + 他占術ショートカット + SNSシェア |
| 風水占い結果 | `/fortune/fengshui` | 本命卦・吉方位・ラッキーカラー + 他占術ショートカット + SNSシェア |
| おみくじ結果 | `/fortune/omikuji` | 大吉〜大凶（7段階）・各運勢 + 他占術ショートカット + SNSシェア |
| ルーン結果 | `/fortune/rune` | 3石選択（過去・現在・未来）・24ルーン + 他占術ショートカット + SNSシェア |
| 夢占い結果 | `/fortune/dream` | 夢の意味・深層心理・アドバイス + 他占術ショートカット + SNSシェア |
| 手相占い結果 | `/fortune/palm` | Claude Vision による手相解析 + 他占術ショートカット + SNSシェア |
| 占い履歴 | `/history` | 過去の占い結果一覧（最大 50 件）+ クリア機能 |
| ヘルスチェック | `/health` | フロントエンドヘルスチェック（k3s ヘルスチェック用） |

---

## 4. フロントエンド設計

### 技術スタック

| 技術 | バージョン | 用途 |
|------|----------|------|
| Next.js | 16.1.6 | App Router ベースのフレームワーク |
| React | 19.2.3 | UI ライブラリ |
| TypeScript | 5.x | 型安全 |
| Tailwind CSS | 4.x | ユーティリティファーストCSS |
| Lucide React | 0.564.x | アイコンライブラリ |

### ディレクトリ構成

```
frontend/src/
├── app/                          # Next.js App Router
│   ├── layout.tsx                #   ルートレイアウト（Header + フォント + ダークテーマ + JSON-LD）
│   ├── page.tsx                  #   トップページ（ヒーロー + CTA）
│   ├── globals.css               #   デザインシステム定義（@theme）
│   ├── sitemap.ts                #   sitemap.xml 生成
│   ├── robots.ts                 #   robots.txt 生成
│   ├── health/
│   │   └── route.ts              #   ヘルスチェック API（k3s ヘルスチェック用）
│   ├── profile/
│   │   └── page.tsx              #   プロフィール入力フォーム
│   ├── history/
│   │   └── page.tsx              #   占い履歴一覧（最大50件）
│   └── fortune/
│       ├── page.tsx              #   占術選択（ダッシュボードバナー + 19占術カード）
│       ├── dashboard/page.tsx    #   総合運勢ダッシュボード
│       ├── zodiac/page.tsx       #   星座占い結果
│       ├── numerology/page.tsx   #   数秘術結果
│       ├── blood-type/page.tsx   #   血液型占い結果
│       ├── tarot/page.tsx        #   タロット結果
│       ├── eto/page.tsx          #   干支占い結果
│       ├── kyusei/page.tsx       #   九星気学結果
│       ├── animal/page.tsx       #   動物占い結果
│       ├── birth-flower/page.tsx #   誕生花占い結果
│       ├── birthstone/page.tsx   #   誕生石占い結果
│       ├── shichuu/page.tsx      #   四柱推命結果
│       ├── weekday/page.tsx      #   曜日占い結果
│       ├── fengshui/page.tsx     #   風水占い結果
│       ├── omikuji/page.tsx      #   おみくじ結果
│       ├── rune/page.tsx         #   ルーン占い結果
│       ├── dream/page.tsx        #   夢占い結果
│       ├── palm/page.tsx         #   手相占い結果（AI）
│       ├── compatibility/page.tsx #  相性占い結果
│       ├── trends/page.tsx      #   運勢トレンド結果
│       └── ai-reading/page.tsx  #   AI総合鑑定結果
│
├── components/
│   ├── Header.tsx                #   固定ヘッダー（ロゴ + 履歴リンク + プロフィール）
│   ├── LanguageSwitcher.tsx      #   言語切替
│   ├── motion/                   #   Framer Motion コンポーネント
│   └── fortune/
│       ├── FortuneCard.tsx       #   占術選択カード（有効/無効切替）
│       ├── ScoreDisplay.tsx      #   星スコア表示（1〜5、色分け）
│       ├── LoadingState.tsx      #   ローディングアニメーション
│       ├── ErrorState.tsx        #   エラー表示 + リトライボタン
│       ├── ResultCard.tsx        #   結果セクションのカード枠
│       ├── OtherFortunes.tsx     #   他占術ショートカット（結果ページ下部）
│       ├── ShareButtons.tsx      #   SNSシェアボタン（X/LINE/FB/クリップボード）
│       └── RadarChart.tsx        #   SVGレーダーチャート（ダッシュボード用）
│
└── lib/
    ├── types.ts                  #   型定義（UserProfile, RadarScores, DashboardResult 等）
    ├── storage.ts                #   localStorage 管理 + React 同期
    ├── api-client.ts             #   API 呼び出し（19 占術 + ダッシュボード）
    ├── useFortune.ts             #   占い共通フック（履歴自動保存付き）
    ├── fortune-registry.ts       #   占術レジストリ（19占術メタデータ）
    ├── kana-to-romaji.ts         #   カタカナ → ローマ字変換（外来語音対応）
    ├── history.ts                #   占い履歴管理（localStorage, 最大50件）
    └── i18n/                     #   多言語対応 (ja/en)
```

### 状態管理

データベースを使わず、**localStorage** でユーザーのプロフィールを管理しています。

```
┌───────────────────────────────────────────────────────┐
│                    localStorage                       │
│                                                       │
│  Key: "fortune-compass-profile"                       │
│  Value: {                                             │
│    "name": "田中太郎",                                 │
│    "nameKana": "タナカタロウ",                          │
│    "nameRomaji": "tanakataroo",   ← 自動変換          │
│    "birthday": "1990-05-15",                          │
│    "bloodType": "A"               ← null の場合あり    │
│  }                                                    │
└───────────────────────────────────────────────────────┘
```

**React との同期方法:**

`useSyncExternalStore` フックを使い、localStorage の変更を React コンポーネントにリアルタイム反映しています。

```
storage.ts
├── getProfileSnapshot()     ← 現在のプロフィールを返す（キャッシュ付き）
├── getHasProfileSnapshot()  ← プロフィールの有無を返す
├── subscribeStorage(cb)     ← 変更イベントを購読
├── saveProfile(profile)     ← 保存 + キャッシュ無効化
└── loadProfile()            ← 読み込み
```

### 占い履歴

```
┌───────────────────────────────────────────────────────┐
│                    localStorage                       │
│                                                       │
│  Key: "fortune-compass-history"                       │
│  Value: [                                             │
│    {                                                  │
│      "fortuneType": "zodiac",                         │
│      "date": "2026-02-17T12:00:00.000Z",              │
│      "result": { "sign": "牡牛座", "score": 4, ... }  │
│    },                                                 │
│    ...                                                │
│  ]                                                    │
│  最大50件保持（FIFO）                                   │
└───────────────────────────────────────────────────────┘
```

**history.ts:**
```
history.ts
├── getHistory()             ← 履歴一覧を取得
├── saveToHistory(result)    ← 結果を履歴に保存（50件超で最古を削除）
└── clearHistory()           ← 履歴を全クリア
```

`useFortune` フック内で API レスポンス取得後に `saveToHistory()` を自動呼び出し。

### カタカナ → ローマ字変換

数秘術の占いでは名前のローマ字が必要です。フリガナ（カタカナ）を自動でローマ字に変換する仕組みがあります。

```
入力: "タナカタロウ"

変換テーブル:
  タ→ta, ナ→na, カ→ka, タ→ta, ロ→ro, ウ→u

出力: "tanakataroo"
```

**対応パターン:**
- 基本カタカナ 85+ 文字（ア〜ン、濁音、半濁音）
- 拗音（シャ→sha、チャ→cha 等）30+ パターン
- 促音（ッ → 次の子音を重ねる）
- 長音（ー → 直前の母音を繰り返す）

---

## 5. バックエンド設計

### 技術スタック

| 技術 | バージョン | 用途 |
|------|----------|------|
| Express | 5.2.x | HTTP フレームワーク |
| TypeScript | 5.x | 型安全 |
| Jest | 30.x | テストフレームワーク |
| Supertest | - | API テスト |
| ts-node-dev | - | 開発時のホットリロード |

### ディレクトリ構成

```
backend/src/
├── index.ts                     # エントリポイント（Express 設定、ミドルウェア）
├── routes/
│   └── fortune.ts               # 17 エンドポイントのルーティング + バリデーション
├── services/                    # 占いロジック（ビジネスロジック層）
│   ├── zodiac.ts                #   星座占い
│   ├── numerology.ts            #   数秘術
│   ├── blood-type.ts            #   血液型占い
│   ├── tarot.ts                 #   タロット占い
│   ├── dashboard.ts             #   総合ダッシュボード（4占術統合 + レーダースコア）
│   ├── eto.ts                   #   干支（十二支）判定
│   ├── kyusei.ts                #   九星気学判定
│   ├── animal.ts                #   動物占い（60パターン）
│   ├── birth-flower.ts          #   誕生花判定（365日対応）
│   ├── birthstone.ts            #   誕生石判定
│   ├── weekday.ts               #   曜日占い（ツェラーの合同式）
│   ├── fengshui.ts              #   風水占い（本命卦算出）
│   ├── shichuu.ts               #   四柱推命（天干地支）
│   ├── omikuji.ts               #   おみくじ（重み付き7段階）
│   ├── rune.ts                  #   ルーン占い（24ルーン3石選択）
│   ├── dream.ts                 #   夢占い（キーワード検索）
│   └── palm.ts                  #   手相占い（Claude Vision API）
├── data/                        # マスターデータ（静的データ層）
│   ├── zodiac-data.ts           #   12 星座の境界日、エレメント、アドバイス文（2〜3文）
│   ├── tarot-cards.ts           #   大アルカナ 22 枚のデータ
│   ├── blood-type-data.ts       #   A/B/O/AB の性格・相性データ
│   ├── eto-data.ts              #   十二支データ
│   ├── kyusei-data.ts           #   九星データ
│   ├── animal-data.ts           #   動物キャラ60パターンデータ
│   ├── birth-flower-data.ts     #   365日誕生花データ
│   ├── birthstone-data.ts       #   12月誕生石データ
│   ├── weekday-data.ts          #   曜日データ
│   ├── fengshui-data.ts         #   風水（八卦）データ
│   ├── shichuu-data.ts          #   四柱推命（天干地支）データ
│   ├── omikuji-data.ts          #   おみくじ（7段階）データ
│   ├── rune-data.ts             #   24ルーンデータ
│   └── dream-data.ts            #   夢キーワードデータ
└── utils/
    └── seed-random.ts           # djb2 ハッシュ + シード付き乱数
```

### API エンドポイント

すべて `POST` メソッド。

| エンドポイント | リクエストボディ | レスポンス |
|--------------|----------------|----------|
| `POST /api/fortune/zodiac` | `{ birthday: "1990-05-15" }` | 星座・スコア・ラッキー情報 |
| `POST /api/fortune/numerology` | `{ birthday: "1990-05-15", name: "tanakataroo" }` | 運命数・性格・年運 |
| `POST /api/fortune/blood-type` | `{ bloodType: "A" }` | 性格・スコア・相性ランキング |
| `POST /api/fortune/tarot` | `{}` | 3 枚カード + 総合メッセージ |
| `POST /api/fortune/eto` | `{ birthday: "1990-05-15" }` | 十二支・性格・相性 |
| `POST /api/fortune/kyusei` | `{ birthday: "1990-05-15" }` | 九星・本命星・性格・方位 |
| `POST /api/fortune/animal` | `{ birthday: "1990-05-15" }` | 動物キャラ・性格・相性 |
| `POST /api/fortune/birth-flower` | `{ birthday: "1990-05-15" }` | 誕生花・花言葉・性格 |
| `POST /api/fortune/birthstone` | `{ birthday: "1990-05-15" }` | 誕生石・石言葉・パワー |
| `POST /api/fortune/shichuu` | `{ birthday: "1990-05-15", birthTime?: "14:30" }` | 天干地支・五行・性格・運勢 |
| `POST /api/fortune/weekday` | `{ birthday: "1990-05-15" }` | 曜日・性格・ラッキー情報 |
| `POST /api/fortune/fengshui` | `{ birthday: "1990-05-15" }` | 本命卦・吉方位・ラッキーカラー |
| `POST /api/fortune/omikuji` | `{}` | 大吉〜大凶（7段階）・各運勢 |
| `POST /api/fortune/rune` | `{}` | 3石（過去・現在・未来）・ルーン解釈 |
| `POST /api/fortune/dream` | `{ keyword: "空を飛ぶ" }` | 夢の意味・深層心理・アドバイス |
| `POST /api/fortune/palm` | `{ image: "base64..." }` | Claude Vision 手相解析結果 |
| `POST /api/fortune/compatibility` | `{ birthday, partnerBirthday, ... }` | 3軸相性スコア（星座・数秘・血液型） |
| `POST /api/fortune/trends` | `{ birthday, name?, bloodType? }` | 7日間運勢トレンド（SVGチャート用データ） |
| `POST /api/fortune/ai-reading` | `{ birthday, name?, birthTime?, gender? }` | AI総合鑑定（Anthropic SDK） |
| `POST /api/fortune/dashboard` | `{ birthday, name?, bloodType? }` | レーダースコア + 4占術サマリー + 総合アドバイス |
| `GET /api/health` | — | `{ status: "ok", timestamp: "..." }` |

### 環境変数

| 変数名 | 用途 |
|--------|------|
| `NODE_ENV` | 実行環境（development / production） |
| `PORT` | サーバーポート（デフォルト 8080） |
| `CORS_ORIGIN` | CORS 許可オリジン |
| `ANTHROPIC_API_KEY` | Anthropic API キー（手相占い Claude Vision 用） |

### バリデーション

各エンドポイントで入力値を検証し、不正な値には `400 Bad Request` を返します。

```
POST /api/fortune/zodiac
├── birthday が存在するか？        → 400: "birthday is required"
├── Date パースが有効か？           → 400: "Invalid birthday format"
└── サービス内でエラー？            → 500: "Internal server error"

POST /api/fortune/blood-type
├── bloodType が存在するか？        → 400: "bloodType is required"
├── A/B/O/AB のいずれかか？        → 400: "Invalid blood type"
└── サービス内でエラー？            → 500: "Internal server error"
```

### ミドルウェア構成

```
Express App
  │
  ├── cors({ origin: CORS_ORIGIN })     ← CORS 制御
  ├── express.json()                     ← JSON パース
  ├── GET /api/health                    ← ヘルスチェック
  └── /api/fortune/*                     ← 占いルーター
        ├── POST /zodiac
        ├── POST /numerology
        ├── POST /blood-type
        ├── POST /tarot
        ├── POST /dashboard
        ├── POST /eto
        ├── POST /kyusei
        ├── POST /animal
        ├── POST /birth-flower
        ├── POST /birthstone
        ├── POST /shichuu
        ├── POST /weekday
        ├── POST /fengshui
        ├── POST /omikuji
        ├── POST /rune
        ├── POST /dream
        └── POST /palm
```

---

## 6. 占いロジック詳細

### 6.1 共通の仕組み: シード付き乱数

星座占い・血液型占いでは「日替わりだが同日同結果」を実現するため、**シード付き疑似乱数**を使っています。

```
┌─────────────────────────────────────────────────────────┐
│                  seed-random.ts                          │
│                                                         │
│  1. 今日の日付を取得 → "2026-02-16"                       │
│                                                         │
│  2. シード文字列を組み立て                                 │
│     例: "2026-02-16-aries-score"                         │
│                                                         │
│  3. djb2 ハッシュ関数でハッシュ値を算出                     │
│     hash = 5381                                          │
│     for each char: hash = (hash * 33) ^ charCode         │
│     hash = hash >>> 0  (符号なし32bit整数に変換)           │
│                                                         │
│  4. sin関数で 0〜1 の疑似乱数に変換                        │
│     x = Math.sin(hash) * 10000                           │
│     random = x - Math.floor(x)                           │
│                                                         │
│  5. スコア（1〜5）やリスト選択に使用                        │
│     score = Math.floor(random * 5) + 1                   │
│     choice = array[Math.floor(random * array.length)]    │
└─────────────────────────────────────────────────────────┘
```

**特徴:**
- 同じ日付 + 同じ入力 → 必ず同じ結果（再現性）
- 日付が変わると結果も変わる（日替わり感）
- データベース不要（計算のみで完結）

---

### 6.2 星座占い

**アルゴリズム:**

```
入力: birthday = "1990-05-15"
  │
  ▼
① 月日を抽出 → month=5, day=15
  │
  ▼
② 12星座テーブルから該当する星座を判定
   ┌──────────┬───────────────┬──────────┐
   │ 星座      │ 期間          │ エレメント │
   ├──────────┼───────────────┼──────────┤
   │ 牡羊座    │ 3/21 〜 4/19  │ 火        │
   │ 牡牛座    │ 4/20 〜 5/20  │ 地        │  ← 5/15 はここ
   │ 双子座    │ 5/21 〜 6/21  │ 風        │
   │ ...       │ ...           │ ...       │
   │ 山羊座    │ 12/22 〜 1/19 │ 地        │  ← 年跨ぎ対応あり
   └──────────┴───────────────┴──────────┘
  │
  ▼
③ シード付き乱数で日替わりスコア・ラッキー情報を算出
   seed = "2026-02-16-taurus"
   score      = seededScore(seed + "-score")      → 1〜5
   luckyColor = seededChoice(seed + "-color", 15色) → "パープル"
   luckyItem  = seededChoice(seed + "-item",  15品) → "手帳"
   advice     = seededChoice(seed + "-advice", 15文) → "直感を信じて..."
  │
  ▼
出力: { sign: "牡牛座", element: "地", score: 3,
        luckyColor: "パープル", luckyItem: "手帳", advice: "..." }
```

**山羊座の年跨ぎ処理:**
山羊座は 12/22〜1/19 と年を跨ぐため、他の星座より先に判定します（`findZodiacSign` 関数の先頭で処理）。

---

### 6.3 数秘術

**アルゴリズム:**

```
入力: birthday = "1990-05-15", name = "tanakataroo"
  │
  ├──────────────────────────────────────────────┐
  ▼                                              ▼
① 生年月日の運命数算出                          ② 名前のピタゴリアン変換
  "1990-05-15" → "19900515"                      ピタゴリアンテーブル:
  1+9+9+0+0+5+1+5 = 30                           a=1 b=2 c=3 d=4 e=5
  3+0 = 3                                         f=6 g=7 h=8 i=9
  → 運命数: 3                                     j=1 k=2 l=3 m=4 ...

  ※ マスターナンバー判定:                          t+a+n+a+k+a+t+a+r+o+o
  11, 22, 33 が出たら還元せず保持                    = 2+1+5+1+2+1+2+1+9+6+6
  例: 合計=29 → 2+9=11 → 停止（マスターナンバー）    = 36 → 3+6 = 9
  │                                              │
  ▼                                              ▼
③ 運命数に対応する固定データを返す              （現在は運命数のみ使用）
   運命数 3:
   ├── 性格: ["創造性", "表現力", "社交性"]
   ├── 年運: "表現力が輝く年..."
   ├── 相性: [1, 5]
   └── アドバイス: "創造力を存分に発揮しましょう..."
  │
  ▼
出力: { destinyNumber: 3, personalityTraits: [...],
        yearFortune: "...", compatibility: [1,5], advice: "..." }
```

**運命数の意味:**
| 運命数 | キーワード |
|--------|----------|
| 1 | リーダーシップ・独立心・開拓精神 |
| 2 | 協調性・感受性・思いやり |
| 3 | 創造性・表現力・社交性 |
| 4 | 堅実・忍耐力・組織力 |
| 5 | 自由・冒険心・適応力 |
| 6 | 愛情・責任感・調和 |
| 7 | 知的・分析的・内省的 |
| 8 | 野心・実行力・成功志向 |
| 9 | 博愛・理想主義・芸術性 |
| 11 | 直感力・スピリチュアル（マスターナンバー） |
| 22 | ビジョナリー・実現力（マスターナンバー） |
| 33 | マスターヒーラー・無条件の愛（マスターナンバー） |

---

### 6.4 血液型占い

**アルゴリズム:**

```
入力: bloodType = "A"
  │
  ▼
① 固定データから性格・相性を取得
   ┌────────┬────────────────────────┬──────────────┐
   │ 血液型  │ 性格                   │ 相性ランキング │
   ├────────┼────────────────────────┼──────────────┤
   │ A型     │ 几帳面で誠実、協調性が高い │ A → AB → O → B │
   │ B型     │ マイペースで好奇心旺盛    │ B → AB → O → A │
   │ O型     │ おおらかでリーダー気質     │ O → A → B → AB │
   │ AB型    │ 冷静で合理的、ミステリアス │ AB → B → A → O │
   └────────┴────────────────────────┴──────────────┘
  │
  ▼
② シード付き乱数で日替わりスコア・アドバイスを算出
   seed = "2026-02-16-A"
   score  = seededScore(seed + "-score")       → 1〜5
   advice = seededChoice(seed + "-advice", 12文) → "周囲との調和を..."
  │
  ▼
出力: { bloodType: "A", personality: "几帳面で...",
        score: 4, compatibilityRanking: ["A","AB","O","B"],
        advice: "周囲との調和を..." }
```

---

### 6.5 タロット占い

**アルゴリズム:**

```
入力: なし（毎回ランダム）
  │
  ▼
① 大アルカナ 22 枚を Fisher-Yates シャッフル
   [愚者, 魔術師, 女教皇, 女帝, 皇帝, 教皇, 恋人, 戦車,
    力, 隠者, 運命の輪, 正義, 吊るされた男, 死神, 節制,
    悪魔, 塔, 星, 月, 太陽, 審判, 世界]

   Fisher-Yates:
   for i = 21 → 1:
     j = random(0 〜 i)
     swap(cards[i], cards[j])   ← Math.random() 使用
  │
  ▼
② 上から 3 枚を抽出
   ┌───────────┬───────────┬───────────┐
   │  1枚目     │  2枚目     │  3枚目     │
   │  過去      │  現在      │  未来      │
   │  (past)    │ (present)  │ (future)   │
   └───────────┴───────────┴───────────┘
  │
  ▼
③ 各カードの正逆判定（50% の確率）
   isReversed = Math.random() < 0.5
   ├── 正位置 → meaning（正位置の意味）を表示
   └── 逆位置 → reversedMeaning（逆位置の意味）を表示
  │
  ▼
④ 総合メッセージをランダム選択（12 パターン）
  │
  ▼
出力: { spread: "three-card",
        cards: [
          { positionLabel: "過去", name: "塔", isReversed: false,
            meaning: "急激な変化、破壊と再生..." },
          { positionLabel: "現在", name: "星", isReversed: true,
            reversedMeaning: "希望の喪失、失望..." },
          { positionLabel: "未来", name: "太陽", isReversed: false,
            meaning: "成功、喜び、達成..." }
        ],
        overallMessage: "カードは内なる成長の道を示しています..." }
```

**タロットが他の占いと異なる点:**
- `Math.random()` を使用（シード付き乱数ではない）
- **毎回異なる結果**が出る（リロードで変わる）
- 「もう一度引く」ボタンで再抽選可能

---

### 6.6 干支占い

**アルゴリズム:** 生年月日から西暦年を取得し、十二支テーブル（子・丑・寅・卯・辰・巳・午・未・申・酉・戌・亥）から該当する干支を判定。固定の性格・相性データを返却。

### 6.7 九星気学

**アルゴリズム:** 生年月日の年から本命星（一白水星〜九紫火星）を算出。九星データから性格・方位・ラッキーカラーを返却。

### 6.8 動物占い

**アルゴリズム:** 個性心理學に基づくJDN計算式 `(Excelシリアル値 + 8) % 60 + 1` で60キャラクターを判定（Excelシリアル値 = JDN - 2415019）。12動物 × 各4〜6キャラ構成。SUN/EARTH/MOONの3グループ分類とともに性格・相性を返却。

### 6.9 誕生花占い

**アルゴリズム:** 生年月日の月日から365日対応の誕生花テーブルを参照。花名・花言葉・性格傾向を返却。

### 6.10 誕生石占い

**アルゴリズム:** 生年月日の月から12月分の誕生石テーブルを参照。石名・石言葉・パワーを返却。

### 6.11 四柱推命

**アルゴリズム:** 生年月日から天干（甲〜癸）・地支（子〜亥）を算出し、五行のバランスから性格・運勢を判定。

### 6.12 曜日占い

**アルゴリズム:** ツェラーの合同式で生年月日の曜日を算出。曜日データから性格・ラッキー情報を返却。

### 6.13 風水占い

**アルゴリズム:** 生年月日と性別から本命卦を算出。八卦データから吉方位・凶方位・ラッキーカラーを返却。

### 6.14 おみくじ

**アルゴリズム:** 重み付きランダムで7段階（大吉・吉・中吉・小吉・末吉・凶・大凶）を抽出。各運勢（恋愛・仕事・健康等）もランダム生成。毎回変動。

### 6.15 ルーン占い

**アルゴリズム:** 24ルーン（エルダーフサルク）からランダムに3石を選択（過去・現在・未来）。各ルーンの正逆位置を判定し、意味・アドバイスを返却。毎回変動。

### 6.16 夢占い

**アルゴリズム:** 入力されたキーワードを夢キーワードデータベースで検索。一致したキーワードの意味・深層心理・アドバイスを返却。

### 6.17 手相占い（AI）

**アルゴリズム:** ユーザーがアップロードした手の画像を Claude Vision API（Anthropic）に送信。AI が手相の線（生命線・知能線・感情線等）を解析し、性格・運勢・アドバイスを生成。`ANTHROPIC_API_KEY` 環境変数が必要。

---

## 7. データフロー

### API リクエスト〜レスポンスの全体フロー

```
┌──────────────┐   ┌──────────────────┐   ┌────────────────────────────┐
│  ブラウザ     │   │  フロントエンド    │   │  バックエンド               │
│              │   │  (Next.js)       │   │  (Express)                │
└──────┬───────┘   └────────┬─────────┘   └──────────┬─────────────────┘
       │                    │                        │
       │  1. 占術を選択      │                        │
       │ ────────────────→  │                        │
       │                    │                        │
       │                    │  2. localStorage から    │
       │                    │     プロフィール読込     │
       │                    │                        │
       │                    │  3. POST /api/fortune/  │
       │                    │     zodiac              │
       │                    │  ──────────────────→    │
       │                    │  { birthday: "..." }    │
       │                    │                        │
       │                    │                        │  4. バリデーション
       │                    │                        │
       │                    │                        │  5. 星座判定
       │                    │                        │     (zodiac-data.ts)
       │                    │                        │
       │                    │                        │  6. シード乱数で
       │                    │                        │     スコア等算出
       │                    │                        │     (seed-random.ts)
       │                    │                        │
       │                    │  7. JSON レスポンス     │
       │                    │  ←──────────────────   │
       │                    │  { sign, score, ... }   │
       │                    │                        │
       │  8. 結果画面を表示  │                        │
       │ ←────────────────  │                        │
       │  スコア（星）       │                        │
       │  ラッキーカラー     │                        │
       │  アドバイス         │                        │
       │                    │                        │
```

### 本番環境でのネットワークフロー

```
ブラウザ
  │
  │ GET https://d71oywvumn06c.cloudfront.net/fortune/zodiac
  ▼
CloudFront
  │ パス: /fortune/zodiac → キャッシュなし → EC2 に転送
  ▼
EC2 (k3s) → Traefik Ingress (/* → frontend:3000)
  │
  ▼
Frontend Pod (Next.js :3000)
  │ HTML を返却
  ▼
ブラウザ（HTML レンダリング）
  │
  │ POST https://d71oywvumn06c.cloudfront.net/api/fortune/zodiac
  ▼
CloudFront
  │ パス: /api/* → キャッシュなし → EC2 に転送
  ▼
EC2 (k3s) → Traefik Ingress (/api/* → backend:8080)
  │
  ▼
Backend Pod (Express :8080)
  │ JSON を返却
  ▼
CloudFront → ブラウザ
```

---

## 8. デザインシステム

### カラーパレット

ダークテーマベースの神秘的な UI。`globals.css` の `@theme` で定義。

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│  背景色                                                  │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐           │
│  │ midnight  │  │deep-purple│  │ twilight  │           │
│  │ #0f0a1e   │  │ #1a1333   │  │ #251d3d   │           │
│  │ メイン背景 │  │ カード背景 │  │ 入力欄背景 │           │
│  └───────────┘  └───────────┘  └───────────┘           │
│                                                         │
│  アクセントカラー                                         │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐           │
│  │  mystic-  │  │ celestial-│  │  aurora-  │           │
│  │  purple   │  │   gold    │  │  green    │           │
│  │ #8b5cf6   │  │ #f5c542   │  │ #34d399   │           │
│  │ プライマリ │  │ 強調・スコア│  │ 成功・高得点│           │
│  └───────────┘  └───────────┘  └───────────┘           │
│                                                         │
│  ┌───────────┐  ┌───────────┐                           │
│  │  ember-   │  │  crimson  │                           │
│  │  orange   │  │ #f43f5e   │                           │
│  │ #fb923c   │  │ エラー・   │                           │
│  │ 中間スコア │  │ 低スコア   │                           │
│  └───────────┘  └───────────┘                           │
│                                                         │
│  テキストカラー                                           │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐           │
│  │  primary  │  │ secondary │  │  muted    │           │
│  │ #f0edf6   │  │ #b8b0d0   │  │ #8a80a0   │           │
│  │ メインテキスト│  │ 補足テキスト│  │ 薄いテキスト│           │
│  └───────────┘  └───────────┘  └───────────┘           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### スコア表示の色分け

`ScoreDisplay` コンポーネントでスコアに応じて色が変わります。

| スコア | 星の数 | 色 | 印象 |
|--------|-------|-----|------|
| 5 | ★★★★★ | celestial-gold (#f5c542) | 最高 |
| 4 | ★★★★☆ | aurora-green (#34d399) | 好調 |
| 3 | ★★★☆☆ | mystic-purple (#8b5cf6) | 普通 |
| 2 | ★★☆☆☆ | ember-orange (#fb923c) | やや低調 |
| 1 | ★☆☆☆☆ | crimson (#f43f5e) | 要注意 |

### フォント

| フォント | 用途 |
|---------|------|
| Inter | 英字・数字 |
| Noto Sans JP | 日本語テキスト |

### アニメーション

- **fade-in**: ページ遷移時に下から 8px スライドしながらフェードイン（0.5 秒）
- **pulse**: ローディング中の星アイコンが脈動（3 つの星が 150ms ずつずれて表示）

---

## 9. Docker 構成

### バックエンド Dockerfile

```
┌─────────────────────────────────────────┐
│  Stage 1: builder                       │
│  node:20-alpine                         │
│                                         │
│  npm ci                                 │
│  tsc (TypeScript → JavaScript)          │
│  → /app/dist/ 生成                      │
└──────────────────┬──────────────────────┘
                   │ dist/ のみコピー
┌──────────────────▼──────────────────────┐
│  Stage 2: runner                        │
│  node:20-alpine                         │
│                                         │
│  npm ci --omit=dev (本番依存のみ)        │
│  COPY dist/ from builder                │
│  USER node (非root)                     │
│  EXPOSE 8080                            │
│  CMD ["node", "dist/index.js"]          │
│                                         │
│  → 軽量イメージ（devDependencies 除外）   │
└─────────────────────────────────────────┘
```

### フロントエンド Dockerfile

```
┌─────────────────────────────────────────┐
│  Stage 1: deps                          │
│  node:20-alpine                         │
│                                         │
│  npm ci (全依存インストール)              │
└──────────────────┬──────────────────────┘
                   │ node_modules
┌──────────────────▼──────────────────────┐
│  Stage 2: builder                       │
│  node:20-alpine                         │
│                                         │
│  next build                             │
│  → .next/standalone/ 生成               │
│  → .next/static/ 生成                   │
└──────────────────┬──────────────────────┘
                   │ standalone + static + public
┌──────────────────▼──────────────────────┐
│  Stage 3: runner                        │
│  node:20-alpine                         │
│                                         │
│  COPY standalone/server.js              │
│  COPY .next/static/                     │
│  COPY public/                           │
│  USER nextjs (非root, UID 1001)         │
│  EXPOSE 3000                            │
│  CMD ["node", "server.js"]              │
│                                         │
│  → 超軽量（standalone = 必要ファイルのみ） │
└─────────────────────────────────────────┘
```

**standalone モードのメリット:**
通常の Next.js ビルドでは `node_modules` 全体（数百 MB）が必要ですが、standalone モードでは必要なファイルのみをコピーするため、Docker イメージが大幅に軽量化されます。

---

## 10. AWS インフラ構成

### 使用 AWS サービス一覧

| # | サービス | 役割 | 月額概算 |
|---|---------|------|---------|
| 1 | VPC | 仮想ネットワーク（サブネット + ルーティング） | $0 |
| 2 | Internet Gateway | VPC ↔ インターネット通信 | $0 |
| 3 | EC2 (t3.small) | k3s クラスタ実行（2vCPU / 2GB） | ~$9 |
| 4 | Elastic IP | EC2 用固定 IP | $0 |
| 5 | CloudFront | HTTPS 終端 + 静的アセットキャッシュ | ~$0 |
| 6 | ECR | Docker イメージ保管（2 リポジトリ） | ~$1 |
| 7 | EBS (gp3) | EC2 ルートボリューム（20GB） | ~$2 |
| 8 | S3 | Terraform ステートファイル保存 | < $1 |
| 9 | DynamoDB | Terraform ステートロック | < $1 |
| 10 | IAM | ロール・ポリシー管理 | $0 |
| 11 | Lambda | EC2 ライフサイクル管理（管理コンソール） | $0（無料枠内） |
| 12 | Step Functions | EC2 起動・停止ワークフロー | $0（無料枠内） |
| 13 | API Gateway | 管理コンソール REST API（API Key 認証） | $0（無料枠内） |
| 14 | S3（管理コンソール） | 管理コンソール静的ウェブサイト | $0（無料枠内） |
| 15 | CloudFront Function | `/admin` パスリライト | $0 |
| 16 | MediaConvert | 動画変換（MP4 + HLS） | 従量課金 |
| 17 | Security Hub | セキュリティ統合ダッシュボード | ~$0〜5 |
| 18 | GuardDuty | 脅威検出 | ~$0〜3 |
| 19 | Inspector | 脆弱性スキャン（EC2 / ECR） | ~$0〜2 |
| 20 | AWS Config | リソース設定記録 + コンプライアンスルール | ~$0〜2 |
| 21 | IAM Access Analyzer | IAM 外部アクセス分析 | $0 |
| 22 | Bedrock Agent | 対話型占い AI コンシェルジュ | 従量課金 |
| 23 | EventBridge | MediaConvert ジョブ完了通知 | $0 |
| | **合計** | | **~$19〜24/月**（EC2 停止時は ~$10〜15/月） |

### ネットワーク構成

```
┌─────────────────────────────────────────────────────────────┐
│  VPC: 10.0.0.0/16                                           │
│                                                             │
│  ┌─────────────────────────┐  ┌─────────────────────────┐  │
│  │ Public Subnet            │  │ Public Subnet            │  │
│  │ 10.0.0.0/24              │  │ 10.0.1.0/24              │  │
│  │ ap-northeast-1a          │  │ ap-northeast-1c          │  │
│  │                          │  │                          │  │
│  │ [EC2 k3s] [EIP]         │  │                          │  │
│  └─────────────────────────┘  └─────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**なぜ Public Subnet + EC2？**
- k3s（軽量 Kubernetes）を EC2 1台で実行し、コスト削減（NAT Gateway / ALB / ECS 不要）
- Traefik Ingress（k3s 内蔵）がパスベースルーティングを担当
- CloudFront 経由でのみ HTTPS アクセス

### セキュリティグループ

```
┌──────────────────────────────┐
│  k3s SG (EC2)                 │
│                               │
│  Inbound:                     │
│    80/tcp  ← 全IP (HTTP)     │  ← CloudFront からのトラフィック
│    443/tcp ← 全IP (HTTPS)    │
│    22/tcp  ← 全IP (SSH)      │  ← 管理アクセス
│    6443/tcp ← 全IP (k8s API) │  ← Kubernetes API
│                               │
│  Outbound:                    │
│    All ← anywhere            │  ← ECR pull, 外部通信
└──────────────────────────────┘
```

### Terraform モジュール構成

```
infra/terraform/
├── modules/
│   ├── networking/      # VPC, Subnet x2, IGW,
│   │                    # Route Table, Association x2 (7リソース)
│   │
│   ├── ecr/             # ECR Repository x2,
│   │                    # Lifecycle Policy x2 (4リソース)
│   │
│   ├── ec2-k3s/         # EC2, SG, EIP, IAM, Key Pair,
│   │                    # user_data (k3s + K8s manifests) (10リソース)
│   │
│   ├── cloudfront/      # CloudFront Distribution + CF Function (3リソース)
│   │
│   ├── management/      # Lambda, Step Functions x2, API Gateway,
│   │                    # S3, IAM Role/Policy 等 (28リソース)
│   │
│   ├── mediaconvert/    # S3 x2, Lambda, IAM x2, EventBridge (12リソース)
│   │
│   ├── security/        # Security Hub, GuardDuty, Inspector,
│   │                    # Config, Access Analyzer (13リソース)
│   │
│   └── bedrock/         # Bedrock Agent, Lambda, IAM x2 (9リソース)
│
└── environments/
    └── dev/             # モジュール結合 + 変数 + State設定
        ├── main.tf      #   8モジュールの結合
        ├── variables.tf #   変数定義
        ├── outputs.tf   #   出力定義（URL等）
        └── backend.tf   #   S3 State設定
```

**合計: ~80 リソース**（Phase 12 で mediaconvert / security / bedrock モジュール追加）

### Management Console（EC2 ライフサイクル管理）

EC2 を未使用時に停止してコストを削減するための管理コンソール。

```
管理者 → S3 静的サイト → API Gateway (API Key) → Step Functions → Lambda → EC2
```

| コンポーネント | 役割 |
|--------------|------|
| Lambda (Python 3.12) | EC2 start/stop/status/health-check/ecr-refresh |
| Step Functions x2 | 起動ワークフロー（起動→待機→ヘルスチェック→ECR refresh）/ 停止ワークフロー |
| API Gateway | REST API + API Key 認証 |
| S3 Static Website | 管理コンソール UI |
| SSM Agent (EC2) | リモートコマンド実行 |

**管理コンソール URL**: https://d71oywvumn06c.cloudfront.net/admin（CloudFront HTTPS 経由）

### Phase 12: 非コンピュート系 AWS サービス拡張

| 機能 | サービス | 概要 |
|------|---------|------|
| CloudFront `/admin` | CloudFront Function | 管理コンソール HTTPS 配信 |
| 動画変換 | MediaConvert + S3 + Lambda | S3 アップロード → MP4 + HLS 自動変換 |
| セキュリティ監査 | Security Hub / GuardDuty / Inspector / Config / Access Analyzer | 既存インフラの監査 |
| AI 占い | Bedrock Agent + Lambda | 自然言語で占い実行 |

---

## 11. CI/CD パイプライン

### パイプライン全体図

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  開発者が git push origin master                                 │
│     │                                                           │
│     ▼                                                           │
│  GitHub Actions トリガー（push to master / workflow_dispatch）    │
│     │                                                           │
│     ├─── Job 1: test-backend (約19秒) ──────────────────────┐   │
│     │    │                                                  │   │
│     │    ├── actions/checkout@v4                             │   │
│     │    ├── actions/setup-node@v4 (Node 20)                │   │
│     │    ├── npm ci (依存インストール)                        │   │
│     │    └── npm test (75テスト実行)                          │   │
│     │         ├── 星座占いテスト (境界値24パターン含む)        │   │
│     │         ├── 数秘術テスト (マスターナンバー含む)          │   │
│     │         ├── 血液型テスト                               │   │
│     │         ├── タロットテスト (重複チェック含む)            │   │
│     │         └── APIエンドポイントテスト                      │   │
│     │                                                       │   │
│     │    テスト失敗 → パイプライン停止（デプロイされない）      │   │
│     │                                                       │   │
│     └─── Job 2: build-and-deploy (約1分50秒) ←── 依存 ─────┘   │
│          │                                                      │
│          ├── AWS OIDC 認証                                       │
│          │   └── IAM Role: fortune-compass-github-actions        │
│          │       （長寿命アクセスキーは使用しない）               │
│          │                                                      │
│          ├── ECR ログイン                                        │
│          │                                                      │
│          ├── Backend Docker build & push                        │
│          │   tag: ${git_sha} + latest                           │
│          │                                                      │
│          ├── Frontend Docker build & push                       │
│          │   tag: ${git_sha} + latest                           │
│          │                                                      │
│          └── SSH で EC2 (k3s) にデプロイ                          │
│               ├── ECR pull secret をリフレッシュ                  │
│               ├── kubectl set image で新イメージに更新            │
│               │   （backend + frontend 両方）                    │
│               ├── kubectl rollout status で完了待ち              │
│               │   （ローリングアップデート:                       │
│               │     新Pod起動 → ヘルスチェック通過 → 旧Pod停止）  │
│               └── kubectl get pods で最終確認                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### OIDC 認証の仕組み

GitHub Actions と AWS を安全に接続するため、**OIDC（OpenID Connect）**を使用しています。

```
GitHub Actions                        AWS
     │                                 │
     │  1. GitHub が JWT トークン発行    │
     │  ──────────────────────────→    │
     │     sub: repo:dan-yuta/         │
     │          fortune-compass:*      │
     │     aud: sts.amazonaws.com      │
     │                                 │
     │                                 │  2. AWS が JWT を検証
     │                                 │     (OIDC Provider 経由)
     │                                 │
     │                                 │  3. 条件一致で一時認証情報を発行
     │                                 │     (15分間有効)
     │  4. 一時認証情報を受け取り       │
     │  ←──────────────────────────   │
     │                                 │
     │  5. ECR push, Terraform apply   │
     │  ──────────────────────────→    │
```

**メリット:** AWS のアクセスキーを GitHub に保存する必要がなく、セキュリティが高い。

### イメージタグ戦略

| タグ | 例 | 用途 |
|-----|-----|------|
| git SHA | `761ebaa9fd19...` | 特定コミットに対応。ロールバック時に使用 |
| latest | `latest` | 常に最新。開発・確認用 |

---

## 12. セキュリティ設計

| レイヤー | 対策 | 詳細 |
|---------|------|------|
| 通信暗号化 | CloudFront HTTPS | デフォルト証明書で SSL/TLS 終端 |
| ネットワーク隔離 | Security Group | EC2 はポート 80/443/22/6443 のみ開放 |
| Ingress 制御 | Traefik | k3s 内蔵 Traefik がパスベースルーティング |
| 最小権限 | IAM | EC2 インスタンスロールは ECR pull のみ |
| CORS | Express ミドルウェア | CloudFront ドメインからのみ API リクエスト許可 |
| CI/CD 認証 | GitHub OIDC | 長寿命アクセスキー不使用、一時認証のみ |
| コンテナ実行 | 非 root ユーザー | Backend: `node` ユーザー / Frontend: `nextjs` ユーザー |
| イメージ管理 | ECR ライフサイクル | 10 世代超の古いイメージを自動削除 |
| 入力検証 | Express バリデーション | 全 API エンドポイントで入力値を検証、不正値は 400 |

---

## 13. ファイル一覧

### バックエンド（38 ファイル）

| ファイル | 行数 | 役割 |
|---------|------|------|
| `backend/src/index.ts` | 25 | Express エントリポイント、CORS、ヘルスチェック |
| `backend/src/routes/fortune.ts` | ~95 | 17 エンドポイントのルーティング + バリデーション |
| `backend/src/services/zodiac.ts` | 57 | 星座判定 + シード付きスコア生成 |
| `backend/src/services/numerology.ts` | 82 | 運命数計算 + ピタゴリアン変換 |
| `backend/src/services/blood-type.ts` | 32 | 血液型判定 + シード付きスコア生成 |
| `backend/src/services/tarot.ts` | 61 | Fisher-Yates シャッフル + 3 枚抽出 |
| `backend/src/services/dashboard.ts` | ~120 | 4 占術統合 + レーダースコア算出 |
| `backend/src/services/eto.ts` | 35 | 干支（十二支）判定 |
| `backend/src/services/kyusei.ts` | 41 | 九星気学判定 |
| `backend/src/services/animal.ts` | 40 | 動物占い（60パターン） |
| `backend/src/services/birth-flower.ts` | 38 | 誕生花判定（365日対応） |
| `backend/src/services/birthstone.ts` | 38 | 誕生石判定 |
| `backend/src/services/weekday.ts` | 55 | 曜日占い（ツェラーの合同式） |
| `backend/src/services/fengshui.ts` | 42 | 風水占い（本命卦算出） |
| `backend/src/services/shichuu.ts` | 84 | 四柱推命（天干地支） |
| `backend/src/services/omikuji.ts` | 58 | おみくじ（重み付き7段階） |
| `backend/src/services/rune.ts` | 59 | ルーン占い（24ルーン3石選択） |
| `backend/src/services/dream.ts` | 51 | 夢占い（キーワード検索） |
| `backend/src/services/palm.ts` | 108 | 手相占い（Claude Vision API） |
| `backend/src/data/zodiac-data.ts` | ~80 | 12 星座マスターデータ（アドバイス拡充済み） |
| `backend/src/data/tarot-cards.ts` | ~70 | 大アルカナ 22 枚マスターデータ（メッセージ拡充済み） |
| `backend/src/data/blood-type-data.ts` | ~55 | 血液型性格・相性マスターデータ（アドバイス拡充済み） |
| `backend/src/data/eto-data.ts` | 39 | 十二支データ |
| `backend/src/data/kyusei-data.ts` | 33 | 九星データ |
| `backend/src/data/animal-data.ts` | 131 | 動物キャラ60パターンデータ |
| `backend/src/data/birth-flower-data.ts` | 417 | 365日誕生花データ |
| `backend/src/data/birthstone-data.ts` | 37 | 12月誕生石データ |
| `backend/src/data/weekday-data.ts` | 26 | 曜日データ |
| `backend/src/data/fengshui-data.ts` | 66 | 風水（八卦）データ |
| `backend/src/data/shichuu-data.ts` | 38 | 四柱推命（天干地支）データ |
| `backend/src/data/omikuji-data.ts` | 87 | おみくじ（7段階）データ |
| `backend/src/data/rune-data.ts` | 45 | 24ルーンデータ |
| `backend/src/data/dream-data.ts` | 93 | 夢キーワードデータ |
| `backend/src/utils/seed-random.ts` | 27 | djb2 ハッシュ + シード付き乱数 |
| `backend/Dockerfile` | 20 | マルチステージ Docker ビルド |
| `backend/.dockerignore` | 5 | Docker ビルド除外設定 |
| `backend/package.json` | - | 依存・スクリプト定義 |
| `backend/tsconfig.json` | - | TypeScript 設定 |

### フロントエンド（41 ファイル）

| ファイル | 行数 | 役割 |
|---------|------|------|
| `frontend/src/app/layout.tsx` | ~60 | ルートレイアウト（フォント + ダークテーマ + Header + JSON-LD + DNS prefetch） |
| `frontend/src/app/page.tsx` | 80 | トップページ（ヒーロー + CTA + 占術アイコン） |
| `frontend/src/app/globals.css` | ~40 | デザインシステム定義（@theme + WCAG AA 色） |
| `frontend/src/app/sitemap.ts` | ~25 | sitemap.xml 生成 |
| `frontend/src/app/robots.ts` | ~15 | robots.txt 生成 |
| `frontend/src/app/health/route.ts` | 5 | ヘルスチェック API Route（k3s ヘルスチェック用） |
| `frontend/src/app/profile/page.tsx` | 268 | プロフィール入力フォーム |
| `frontend/src/app/history/page.tsx` | ~120 | 占い履歴一覧（最大50件 + クリア機能） |
| `frontend/src/app/fortune/page.tsx` | ~117 | 占術選択画面（ダッシュボードバナー + 19占術カード） |
| `frontend/src/app/fortune/dashboard/page.tsx` | ~213 | 総合運勢ダッシュボード |
| `frontend/src/app/fortune/zodiac/page.tsx` | ~150 | 星座占い結果 + OtherFortunes + ShareButtons |
| `frontend/src/app/fortune/numerology/page.tsx` | ~165 | 数秘術結果 + OtherFortunes + ShareButtons |
| `frontend/src/app/fortune/blood-type/page.tsx` | ~170 | 血液型占い結果 + OtherFortunes + ShareButtons |
| `frontend/src/app/fortune/tarot/page.tsx` | ~180 | タロット結果 + OtherFortunes + ShareButtons |
| `frontend/src/app/fortune/eto/page.tsx` | 87 | 干支占い結果 |
| `frontend/src/app/fortune/kyusei/page.tsx` | 90 | 九星気学結果 |
| `frontend/src/app/fortune/animal/page.tsx` | 87 | 動物占い結果 |
| `frontend/src/app/fortune/birth-flower/page.tsx` | 87 | 誕生花占い結果 |
| `frontend/src/app/fortune/birthstone/page.tsx` | 87 | 誕生石占い結果 |
| `frontend/src/app/fortune/shichuu/page.tsx` | 110 | 四柱推命結果 |
| `frontend/src/app/fortune/weekday/page.tsx` | 90 | 曜日占い結果 |
| `frontend/src/app/fortune/fengshui/page.tsx` | 174 | 風水占い結果 |
| `frontend/src/app/fortune/omikuji/page.tsx` | 165 | おみくじ結果 |
| `frontend/src/app/fortune/rune/page.tsx` | 137 | ルーン占い結果 |
| `frontend/src/app/fortune/dream/page.tsx` | 128 | 夢占い結果 |
| `frontend/src/app/fortune/palm/page.tsx` | 245 | 手相占い結果（AI） |
| `frontend/src/components/Header.tsx` | ~35 | 固定ヘッダー（ロゴ + 履歴 + プロフィール） |
| `frontend/src/components/fortune/FortuneCard.tsx` | 66 | 占術選択カード |
| `frontend/src/components/fortune/ScoreDisplay.tsx` | 49 | 星スコア表示（1〜5） |
| `frontend/src/components/fortune/LoadingState.tsx` | 22 | ローディングアニメーション |
| `frontend/src/components/fortune/ErrorState.tsx` | 26 | エラー + リトライ |
| `frontend/src/components/fortune/ResultCard.tsx` | 15 | 結果セクション枠 |
| `frontend/src/components/fortune/OtherFortunes.tsx` | ~65 | 他占術ショートカット |
| `frontend/src/components/fortune/ShareButtons.tsx` | ~100 | SNSシェアボタン（X/LINE/FB/クリップボード） |
| `frontend/src/components/fortune/RadarChart.tsx` | ~153 | SVG レーダーチャート |
| `frontend/src/lib/types.ts` | ~75 | 型定義（RadarScores, DashboardResult 追加） |
| `frontend/src/lib/storage.ts` | 75 | localStorage 管理 + React 同期 |
| `frontend/src/lib/api-client.ts` | ~75 | API クライアント（19 占術 + ダッシュボード） |
| `frontend/src/lib/fortune-registry.ts` | 78 | 占術レジストリ（19占術メタデータ） |
| `frontend/src/lib/kana-to-romaji.ts` | ~240 | カタカナ → ローマ字変換（外来語音対応） |
| `frontend/src/lib/history.ts` | ~40 | 占い履歴管理（localStorage, 最大50件） |

### インフラ（30+ ファイル）

| ファイル | 役割 |
|---------|------|
| `infra/terraform/modules/networking/{main,variables,outputs}.tf` | VPC, Subnet, IGW, Route Table |
| `infra/terraform/modules/ecr/{main,variables,outputs}.tf` | ECR リポジトリ x2 |
| `infra/terraform/modules/ec2-k3s/{main,variables,outputs}.tf` | EC2, SG, EIP, IAM, user_data |
| `infra/terraform/modules/ec2-k3s/user_data.sh.tpl` | k3s インストール + K8s マニフェスト |
| `infra/terraform/modules/cloudfront/{main,variables,outputs}.tf` | CloudFront Distribution + CF Function |
| `infra/terraform/modules/management/{main,variables,outputs}.tf` | Lambda, Step Functions, API Gateway, S3 (管理コンソール) |
| `infra/terraform/modules/management/lambda/ec2_manager.py` | EC2 起動/停止/ステータス Lambda |
| `infra/terraform/modules/mediaconvert/{main,variables,outputs}.tf` | S3 x2, Lambda, IAM, EventBridge (動画変換) |
| `infra/terraform/modules/mediaconvert/lambda/transcode_trigger.py` | S3 → MediaConvert ジョブ作成 Lambda |
| `infra/terraform/modules/security/{main,variables,outputs}.tf` | Security Hub, GuardDuty, Inspector, Config, Access Analyzer |
| `infra/terraform/modules/bedrock/{main,variables,outputs}.tf` | Bedrock Agent, Lambda, IAM |
| `infra/terraform/modules/bedrock/api_schema.yaml` | OpenAPI schema (占い API 定義) |
| `infra/terraform/modules/bedrock/lambda/fortune_bridge.py` | Bedrock Agent → Backend API ブリッジ Lambda |
| `infra/terraform/environments/dev/main.tf` | 9 モジュール結合 |
| `infra/terraform/environments/dev/variables.tf` | 変数定義 |
| `infra/terraform/environments/dev/outputs.tf` | 出力定義 |
| `infra/terraform/environments/dev/backend.tf` | S3 State 設定 |

### CI/CD（1 ファイル）

| ファイル | 役割 |
|---------|------|
| `.github/workflows/deploy.yml` | テスト → Docker build → ECR push → Terraform apply |

### バックエンドテスト（75 ケース）

| テストファイル | ケース数 | 内容 |
|-------------|---------|------|
| `backend/__tests__/services/zodiac.test.ts` | ~20 | 星座境界値、年跨ぎ、スコア範囲 |
| `backend/__tests__/services/numerology.test.ts` | ~15 | 運命数、マスターナンバー、名前変換 |
| `backend/__tests__/services/blood-type.test.ts` | ~10 | 全血液型、無効値 |
| `backend/__tests__/services/tarot.test.ts` | ~15 | 3 枚抽出、重複なし、正逆判定 |
| `backend/__tests__/routes/fortune.test.ts` | ~15 | API レスポンス、バリデーション、エラー（5エンドポイント） |

**バックエンドカバレッジ: 90.17%**

### フロントエンドテスト（31 ケース）

| テストファイル | ケース数 | 内容 |
|-------------|---------|------|
| `frontend/__tests__/components/ScoreDisplay.test.tsx` | 5 | 星5つ表示、aria-label、スコアクランプ |
| `frontend/__tests__/components/ResultCard.test.tsx` | 3 | タイトル・children描画、section要素 |
| `frontend/__tests__/components/ErrorState.test.tsx` | 5 | デフォルト/カスタムエラー文、role=alert |
| `frontend/__tests__/components/LoadingState.test.tsx` | 4 | role=status、aria-live=polite |
| `frontend/__tests__/components/FortuneCard.test.tsx` | 4 | リンク、無効状態、aria-disabled |
| `frontend/__tests__/lib/kana-to-romaji.test.ts` | 5 | 基本変換、長音、濁音、外来語音 |
| `frontend/__tests__/lib/i18n.test.ts` | 5 | 日英辞書取得、全キー一致 |

### E2Eテスト（25 ケース）

| テストファイル | ケース数 | 内容 |
|-------------|---------|------|
| `frontend/e2e/home.spec.ts` | 4 | ヒーロー表示、CTA遷移分岐 |
| `frontend/e2e/profile.spec.ts` | 6 | フォーム表示、バリデーション、保存 |
| `frontend/e2e/fortune.spec.ts` | 9 | 占術選択、各占い遷移、未登録リダイレクト |
| `frontend/e2e/navigation.spec.ts` | 6 | ヘッダー、スキップナビ、404、言語切替 |

**テスト合計: 131 ケース（75 + 31 + 25）**

---

## 14. 関連ドキュメント

| ドキュメント | 内容 |
|------------|------|
| [011_cicd-learning.md](./011_cicd-learning.md) | CI/CD パイプライン学習ガイド（初心者向け） |
| [012_kubernetes-learning.md](./012_kubernetes-learning.md) | Kubernetes 学習・障害テスト手順書（初心者向け） |
